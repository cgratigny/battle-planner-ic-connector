%h1
  Team Report for #{@team.name}

%div
= simple_form_for(@team, url: [@team, :report, { date: params[:date], token: params[:token]}], method: :patch) do |f|
  = f.button :button do
    %span.fas.fa-sync

%h2
  = link_to [@team, :report, { date: (@date.beginning_of_week - 7.days), token: params[:token]}] do
    %span.chevron.fas.fa-chevron-left
  #{@date.beginning_of_week} - #{@date.end_of_week}
  - unless @date.end_of_week.future?
    = link_to [@team, :report, { date: (@date.beginning_of_week + 7.days), token: params[:token]}] do
      %span.chevron.fas.fa-chevron-right

%hr

%table#sortable-table
  %thead
    %tr
      %th
      - ["CALIBRATION", "CONNECTION", "CONDITION", "CONTRIBUTION"].each do |quadrant|
        %th.quadrant-title{colspan: 2, class: quadrant.downcase}= quadrant.downcase.titleize
      %th.quadrant-title Total
  - @team.users.order(name: :asc).each do |user|

    %tr
      %td.name
        - if user.plans.current(@date).present?
          = link_to user.plans.current(@date).plan_url, target: :_blank do
            %span.fas.fa-file
        = user.name
      - ["CALIBRATION", "CONNECTION", "CONDITION", "CONTRIBUTION"].each do |quadrant|
        %td
          .d-none.d-md-block
            - (@date.beginning_of_week..@date.end_of_week).each do |date|
              %span
                - if user.plans.current(@date).nil? || date.future?
                  %span.future.rectangle
                - elsif user.plans.current(@date).success?(date: date, quadrant: quadrant)
                  %span.success.rectangle
                - else
                  %span.fail.rectangle
        %td.percentage
          - if user.plans.current(@date).present?
            - begin
              %span{ class: user.plans.current(@date).percentage_for_week(date: @date, quadrant: quadrant) < 80 ? "needs-attention" : "safe"}
                = user.plans.current(@date).percentage_for_week(date: @date, quadrant: quadrant)
            - rescue => e
              = e.message
          - else
            = "-"
      %td.percentage
        - if user.plans.current(@date).present?
          %span{ class: user.plans.current(@date).percentage_for_week(date: @date) < 80 ? "needs-attention" : "safe"}
            = user.plans.current(@date).percentage_for_week(date: @date)
        - else
          = "-"

%br
%br
%small.align-center
  = link_to [:teams] do
    %span.chevron.fas.fa-chevron-left
    All Teams
